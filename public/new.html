<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>New Releases</title>
    <link rel="stylesheet" href="style.css" />
    <script src="global.js"></script>
    <style>
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #sentinel {
        height: 20px;
        margin-top: 10px;
      }
      #results {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <div class="white-box">
      <h1 style="text-align: center">New Releases</h1>
      <p style="text-align: center; color: #666">
        Top movies & TV from the last 30 days.
      </p>
    </div>

    <div id="results"></div>
    <div id="loadingSpinner" class="spinner"></div>
    <div id="sentinel"></div>

    <script>
      let currentPage = 1;
      let isLoading = false;
      let hasMoreResults = true;

      document.addEventListener("DOMContentLoaded", () => {
        loadNewReleases();

        const sentinel = document.getElementById("sentinel");
        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting && !isLoading && hasMoreResults) {
              currentPage++;
              loadNewReleases();
            }
          },
          { root: null, rootMargin: "100px", threshold: 0.1 }
        );
        observer.observe(sentinel);
      });

      async function loadNewReleases() {
        if (isLoading || !hasMoreResults) return;
        isLoading = true;
        document.getElementById("loadingSpinner").style.display = "block";

        try {
          const response = await fetch(
            `http://localhost:3000/discover?page=${currentPage}`
          );
          const data = await response.json();

          if (!data.results || data.results.length === 0) {
            hasMoreResults = false;
          } else {
            // USE THE SHARED FUNCTION!
            displaySharedResults(data.results);
          }
        } catch (error) {
          console.error("Error", error);
        } finally {
          isLoading = false;
          document.getElementById("loadingSpinner").style.display = "none";
        }
      }
    </script>
  </body>
</html>
