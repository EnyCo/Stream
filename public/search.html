<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Search Movies & TV</title>
    <link rel="stylesheet" href="style.css" />
    <script src="global.js"></script>
    <style>
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      #sentinel {
        height: 20px;
        margin-top: 10px;
      }
      #results {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        padding: 20px;
        justify-content: center;
      }

      /* --- TAB STYLES --- */
      .tab-container {
        display: flex;
        justify-content: center;
        border-bottom: 1px solid #ccc;
        margin-bottom: 20px;
      }
      .tab-btn {
        background: none;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        border-bottom: 3px solid transparent;
      }
      .tab-btn:hover {
        color: #333;
      }
      .tab-btn.active {
        color: #333;
        font-weight: bold;
        border-bottom: 3px solid #333;
      }

      /* Input Styles */
      select,
      input {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        width: 100%;
        max-width: 300px;
        margin-bottom: 10px;
      }

      .tab-content {
        display: none;
        text-align: center;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="white-box">
      <h1 style="text-align: center">Find Movies, TV & People</h1>

      <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('title')">
          By Title
        </button>
        <button class="tab-btn" onclick="switchTab('genre')">By Genre</button>
        <button class="tab-btn" onclick="switchTab('name')">By Name</button>
      </div>

      <div id="tab-title" class="tab-content active">
        <input
          type="text"
          id="titleInput"
          placeholder="Enter movie title (e.g. Matrix)..."
        />
      </div>

      <div id="tab-genre" class="tab-content">
        <div
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
          "
        >
          <label
            style="
              font-size: 0.8em;
              color: #666;
              width: 300px;
              text-align: left;
            "
            >1. Select Category</label
          >
          <select id="typeSelect">
            <option value="multi">Movies & TV Shows</option>
            <option value="movie">Movies Only</option>
            <option value="tv">TV Shows Only</option>
          </select>

          <label
            style="
              font-size: 0.8em;
              color: #666;
              width: 300px;
              text-align: left;
            "
            >2. Select Genre</label
          >
          <select id="genreSelect">
            <option value="">All Genres</option>
          </select>
        </div>
      </div>

      <div id="tab-name" class="tab-content">
        <input
          type="text"
          id="nameInput"
          placeholder="Enter actor/director (e.g. Nolan)..."
        />
      </div>

      <div style="text-align: center; margin-top: 15px">
        <button
          onclick="searchMedia(true)"
          style="
            padding: 10px 30px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
          "
        >
          Search
        </button>
      </div>
    </div>

    <h3
      id="searchContext"
      style="text-align: center; color: #555; display: none; margin-top: 20px"
    ></h3>
    <div id="results"></div>
    <div id="loadingSpinner" class="spinner"></div>
    <div id="sentinel"></div>

    <script>
      let currentPage = 1;
      let currentTab = "title";
      let currentQuery = "";
      let currentParams = {};
      let isLoading = false;
      let hasMoreResults = true;

      // Genre Lists
      const sharedGenres = {
        16: "Animation",
        35: "Comedy",
        80: "Crime",
        99: "Documentary",
        18: "Drama",
        10751: "Family",
        9648: "Mystery",
        37: "Western",
      };

      const movieOnlyGenres = {
        28: "Action",
        12: "Adventure",
        14: "Fantasy",
        36: "History",
        27: "Horror",
        10402: "Music",
        10749: "Romance",
        878: "Science Fiction",
        10770: "TV Movie",
        53: "Thriller",
        10752: "War",
      };

      const tvOnlyGenres = {
        10759: "Action & Adventure",
        10762: "Kids",
        10763: "News",
        10764: "Reality",
        10765: "Sci-Fi & Fantasy",
        10766: "Soap",
        10767: "Talk",
        10768: "War & Politics",
      };

      // UI Helper: Map Movie IDs to TV IDs for the "Both" dropdown view
      const genreMapping = {
        28: 10759, // Action -> Action & Adv
        12: 10759, // Adventure -> Action & Adv
        878: 10765, // Sci-Fi -> Sci-Fi & Fantasy
        14: 10765, // Fantasy -> Sci-Fi & Fantasy
        10752: 10768, // War -> War & Politics
      };

      document.addEventListener("DOMContentLoaded", () => {
        // 1. Initial Setup
        updateGenreDropdown("multi"); // Default to Multi

        // 2. Listen for Type Changes
        document
          .getElementById("typeSelect")
          .addEventListener("change", (e) => {
            updateGenreDropdown(e.target.value);
          });

        // --- 3. HANDLE URL REDIRECTS (from clicking tags) ---
        const params = new URLSearchParams(window.location.search);
        const urlTab = params.get("tab");
        const urlGenre = params.get("genre");
        const urlType = params.get("type") || "multi";

        if (urlTab === "genre") {
          // A. Switch UI Tab
          switchTab("genre");

          // B. Set Type & Update Dropdown List
          document.getElementById("typeSelect").value = urlType;
          updateGenreDropdown(urlType);

          // C. Set Genre (Handle Mapping if needed)
          if (urlGenre) {
            let finalGenre = urlGenre;

            // If we are in 'multi' mode (which uses TV list), map Movie IDs to TV IDs
            // so the dropdown actually selects the matching text.
            if (
              (urlType === "multi" || urlType === "tv") &&
              genreMapping[urlGenre]
            ) {
              finalGenre = genreMapping[urlGenre];
            }

            document.getElementById("genreSelect").value = finalGenre;

            // D. Trigger Search
            searchMedia(true);
          }
        }
        // ----------------------------------------------------

        // 4. Scroll Observer
        const sentinel = document.getElementById("sentinel");
        const observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting && !isLoading && hasMoreResults) {
              loadMore();
            }
          },
          { root: null, rootMargin: "100px", threshold: 0.1 }
        );
        observer.observe(sentinel);
      });

      function updateGenreDropdown(type) {
        const select = document.getElementById("genreSelect");
        select.innerHTML = '<option value="">All Genres</option>';

        let genresToShow = {};

        if (type === "movie") {
          genresToShow = { ...sharedGenres, ...movieOnlyGenres };
        } else {
          // 'tv' OR 'multi' -> Show TV Specific List
          genresToShow = { ...sharedGenres, ...tvOnlyGenres };
        }

        const sorted = Object.entries(genresToShow).sort((a, b) =>
          a[1].localeCompare(b[1])
        );

        sorted.forEach(([id, name]) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = name;
          select.appendChild(option);
        });
      }

      function switchTab(tabName) {
        currentTab = tabName;
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        const index = ["title", "genre", "name"].indexOf(tabName);
        document.querySelectorAll(".tab-btn")[index].classList.add("active");
        document.getElementById(`tab-${tabName}`).classList.add("active");

        document.getElementById("results").innerHTML = "";
        document.getElementById("searchContext").style.display = "none";
        hasMoreResults = true;
      }

      async function searchMedia(isNewSearch = false) {
        const resultsDiv = document.getElementById("results");
        const contextHeader = document.getElementById("searchContext");
        const spinner = document.getElementById("loadingSpinner");

        if (isNewSearch) {
          if (currentTab === "title") {
            const val = document.getElementById("titleInput").value.trim();
            if (!val) {
              alert("Please enter a title.");
              return;
            }
            currentQuery = val;
          } else if (currentTab === "genre") {
            const genre = document.getElementById("genreSelect").value;
            const type = document.getElementById("typeSelect").value;
            currentParams = { genre: genre, type: type };
          } else if (currentTab === "name") {
            const val = document.getElementById("nameInput").value.trim();
            if (!val) {
              alert("Please enter a name.");
              return;
            }
            currentQuery = val;
          }

          currentPage = 1;
          resultsDiv.innerHTML = "";
          contextHeader.style.display = "none";
          hasMoreResults = true;
          isLoading = false;
        }

        if (isLoading || !hasMoreResults) return;
        isLoading = true;
        spinner.style.display = "block";

        try {
          let url = "";

          if (currentTab === "title") {
            url = `http://localhost:3000/search?q=${currentQuery}&page=${currentPage}&type=multi`;
          } else if (currentTab === "genre") {
            url = `http://localhost:3000/discover?genre=${
              currentParams.genre || ""
            }&type=${currentParams.type}&page=${currentPage}`;
          } else if (currentTab === "name") {
            url = `http://localhost:3000/search?q=${currentQuery}&page=${currentPage}&type=person`;
          }

          const response = await fetch(url);
          const data = await response.json();

          if (data.personName && isNewSearch && currentTab === "name") {
            contextHeader.innerText = `Results for: ${data.personName}`;
            contextHeader.style.display = "block";
          }

          if (!data.results || data.results.length === 0) {
            hasMoreResults = false;
            if (isNewSearch)
              resultsDiv.innerHTML =
                '<p style="text-align:center; width:100%;">No results found.</p>';
          } else {
            displaySharedResults(data.results);
          }
        } catch (error) {
          console.error(error);
          if (isNewSearch) resultsDiv.innerHTML = "Error fetching data.";
        } finally {
          isLoading = false;
          spinner.style.display = "none";
        }
      }

      function loadMore() {
        currentPage++;
        searchMedia(false);
      }
    </script>
  </body>
</html>
